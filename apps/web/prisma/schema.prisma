// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// Enums (match existing TS union strings)
// ─────────────────────────────────────────────────────────────────────────────

enum OrgRole {
  owner
  admin
  member
}

enum PlanTier {
  starter
  pro
}

enum BillingStatus {
  inactive
  trialing
  active
  past_due
  canceled
  unpaid
}

enum RunCategory {
  security
  buttons
  ux
}

enum RunStatus {
  passed
  failed
  running
  warning
}

enum RunStepStatus {
  passed
  failed
  warning
}

enum RunStepAction {
  navigate
  scroll
  audit
  click
  wait
  fill
  resize
  screenshot
}

enum NodeStatus {
  passed
  running
  pending
}

enum IssueSeverity {
  error
  warning
}

enum IssueStatus {
  open
  resolved
}

enum IssueCategory {
  security
  other
}

enum HandleSide {
  left
  right
}

enum ArtifactType {
  screenshot
  video
  har
  log
  report
  other
}

enum StorageProvider {
  supabase
  s3
  local
}

// ─────────────────────────────────────────────────────────────────────────────
// Auth / tenancy
// ─────────────────────────────────────────────────────────────────────────────

model User {
  /// Supabase auth.users.id (UUID). You create/ensure this row exists on first login.
  id        String   @id @db.Uuid
  email     String   @unique
  name      String?
  avatarUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships      OrganizationMember[]
  issueResolutions Issue[]              @relation("IssueResolvedBy")
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  OrganizationMember[]
  projects Project[]
  billing  BillingAccount?
}

model OrganizationMember {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  userId    String   @db.Uuid
  role      OrgRole  @default(member)
  createdAt DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([userId])
}

// ─────────────────────────────────────────────────────────────────────────────
// Project + agent access
// ─────────────────────────────────────────────────────────────────────────────

model Project {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  name      String
  slug      String
  targetUrl String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  runs TestRun[]
  keys ApiKey[]

  @@unique([orgId, slug])
  @@index([orgId])
}

model ApiKey {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @db.Uuid
  name      String

  /// Store only a hash (SHA-256). Never store the raw key.
  keyHash   String   @unique

  /// Helpful for UI display / debugging
  prefix    String
  last4     String

  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  revokedAt  DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ─────────────────────────────────────────────────────────────────────────────
// Billing (Stripe)
// ─────────────────────────────────────────────────────────────────────────────

model BillingAccount {
  id                   String        @id @default(uuid()) @db.Uuid
  orgId                String        @unique @db.Uuid
  plan                 PlanTier      @default(starter)
  status               BillingStatus @default(inactive)
  stripeCustomerId     String?       @unique
  stripeSubscriptionId String?       @unique
  stripePriceId        String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

// ─────────────────────────────────────────────────────────────────────────────
// Core testing domain
// ─────────────────────────────────────────────────────────────────────────────

model TestRun {
  id          String      @id @default(uuid()) @db.Uuid
  projectId   String      @db.Uuid

  /// Optional short label like "#a3f7c1"
  label       String?
  name        String
  category    RunCategory
  status      RunStatus   @default(running)

  startedAt   DateTime    @default(now())
  finishedAt  DateTime?
  durationMs  Int?

  /// Denormalized target URL (copied from project at run start for historical accuracy)
  targetUrl   String?

  /// Summary counters to power lists fast (denormalized, maintained on write)
  openErrors   Int @default(0)
  openWarnings Int @default(0)
  totalSteps   Int @default(0)

  /// Monotonic event sequence cursor for live run streaming.
  eventSeq     Int @default(0)

  /// Freeform metadata from agent (version, config, user-agent, viewport, etc.)
  metadata    Json?

  /// For security page (you already have this in mock data)
  securitySynopsis String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  nodes     FlowNode[]
  edges     FlowEdge[]
  steps     RunStep[]
  issues    Issue[]
  artifacts Artifact[]
  events    RunEvent[]

  @@index([projectId, startedAt])
  @@unique([projectId, label])
}

model FlowNode {
  id          String     @id @default(uuid()) @db.Uuid
  runId       String     @db.Uuid

  /// Stable ID used by React Flow: "landing", "login", "dashboard", etc.
  nodeKey     String
  label       String
  url         String
  status      NodeStatus
  step        Int
  durationMs  Int?
  isMain      Boolean    @default(false)
  isLarge     Boolean    @default(false)

  /// React Flow position
  positionX   Int
  positionY   Int

  /// Optional "primary screenshot" path/url
  screenshotPath String?
  screenshotUrl  String?

  sourceHandleSide   HandleSide?
  sourceHandleImageY Float?

  /// For forward compatibility (store any extra node.data fields)
  data Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run           TestRun    @relation(fields: [runId], references: [id], onDelete: Cascade)
  steps         RunStep[]
  issues        Issue[]
  artifacts     Artifact[]
  outgoingEdges FlowEdge[] @relation("EdgeSource")
  incomingEdges FlowEdge[] @relation("EdgeTarget")

  @@unique([runId, nodeKey])
  @@index([runId, step])
}

model FlowEdge {
  id           String   @id @default(uuid()) @db.Uuid
  runId        String   @db.Uuid

  /// Stable ID used by React Flow: "e-landing-login" etc.
  edgeKey      String

  sourceNodeId String   @db.Uuid
  targetNodeId String   @db.Uuid

  type         String?
  label        String?
  zIndex       Int?

  /// Store react-flow style/labelStyle/labelBgStyle/labelBgPadding etc.
  style Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run        TestRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  sourceNode FlowNode @relation("EdgeSource", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode FlowNode @relation("EdgeTarget", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@unique([runId, edgeKey])
  @@index([runId])
}

model RunStep {
  id          String        @id @default(uuid()) @db.Uuid
  runId       String        @db.Uuid
  nodeId      String        @db.Uuid

  /// Chronological index in the run (1..N)
  index       Int
  action      RunStepAction
  target      String
  description String
  reasoning   String
  durationMs  Int?
  status      RunStepStatus

  createdAt DateTime @default(now())

  run       TestRun    @relation(fields: [runId], references: [id], onDelete: Cascade)
  node      FlowNode   @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  issues    Issue[]
  artifacts Artifact[]

  @@unique([runId, index])
  @@index([runId])
  @@index([nodeId])
}

model Issue {
  id             String        @id @default(uuid()) @db.Uuid
  runId          String        @db.Uuid
  nodeId         String        @db.Uuid
  stepId         String?       @db.Uuid

  category       IssueCategory
  title          String
  description    String
  reasoning      String
  element        String
  severity       IssueSeverity
  status         IssueStatus   @default(open)

  detectedAt     DateTime      @default(now())
  resolvedAt     DateTime?
  resolvedById   String?       @db.Uuid
  resolutionNote String?

  run        TestRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  node       FlowNode  @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  step       RunStep?  @relation(fields: [stepId], references: [id], onDelete: SetNull)
  resolvedBy User?     @relation("IssueResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)

  @@index([runId, status])
  @@index([nodeId, status])
  @@index([runId, category])
}

model Artifact {
  id        String          @id @default(uuid()) @db.Uuid
  runId     String          @db.Uuid
  nodeId    String?         @db.Uuid
  stepId    String?         @db.Uuid

  type      ArtifactType
  storage   StorageProvider @default(supabase)

  /// e.g. Supabase bucket + path OR S3 key
  bucket    String?
  path      String?
  url       String?
  mimeType  String?
  sizeBytes Int?
  width     Int?
  height    Int?

  createdAt DateTime @default(now())

  run  TestRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  node FlowNode? @relation(fields: [nodeId], references: [id], onDelete: SetNull)
  step RunStep?  @relation(fields: [stepId], references: [id], onDelete: SetNull)

  @@index([runId])
  @@index([nodeId])
  @@index([stepId])
}

model RunEvent {
  id        String   @id @default(uuid()) @db.Uuid
  runId     String   @db.Uuid
  seq       Int
  type      String
  payload   Json
  createdAt DateTime @default(now())

  run TestRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, seq])
  @@index([runId, createdAt])
}
